<!DOCTYPE html>
<html>
<head>
    <script src="js/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="https://apis.google.com/js/client.js"></script>
    
    <script>
    	function auth()
    	{
    		var config = 
    		{
    			'client_id': '324206727795-6k03tjrjecfg2c7l30l9avea2pb011v4.apps.googleusercontent.com', 
    			'scope': 'https://spreadsheets.google.com/feeds https://www.googleapis.com/auth/userinfo.profile'
    		};
    		gapi.auth.authorize(config, function debug(){
    			writeDebug(gapi.auth.getToken());
    		});
    	}

    	function writeDebug(token)
    	{
    		console.log('login complete');
    		console.log(token);
    		
    		//google.load("gdata", "2");
    		
			var urlLocation = '0AlW1a4Iy0WNvdE1tT1lub09qS3lUT0hjMTEyMi1Vc0E'; //Put the Spreadsheet location here
			var listURL = 'https://spreadsheets.google.com/feeds/list/' + urlLocation + '/od6/private/full?access_token=' + token;
			
			var XMLData = "<entry xmlns=\"http://www.w3.org/2005/Atom\" \
   		 		xmlns:gsx=\"http://schemas.google.com/spreadsheets/2006/extended\"> \
   		 		<link rel=\"http://schemas.google.com/g/2005#post\" href=\""+ listURL +"\"> \
   		 		<gsx:time>1</gsx:time> \
  				<gsx:receiver>1</gsx:receiver> \
  				<gsx:line>60</gsx:line> \
  				<gsx:sender>Elizabeth Bennet</gsx:sender> \
				</entry>";
			
			$.ajax({
                url: listURL,
                type: "POST",
                contentType: 'application/atom+xml',
                data: XMLData,
                success: function(resp) 
                {
                    console.log("ajax request sent");
                }
            });
    	}
    </script>
    
    <script>
        var OAUTHURL    =   'https://accounts.google.com/o/oauth2/auth?';
        var VALIDURL    =   'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=';
        var SCOPE       =   'https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email https://spreadsheets.google.com/feeds';
        var CLIENTID    =   '324206727795-6k03tjrjecfg2c7l30l9avea2pb011v4.apps.googleusercontent.com';
        var REDIRECT    =   'http://localhost/GracePlains/GracePlainsAdminUILayout.html';
        var LOGOUT      =   'http://accounts.google.com/Logout';
        var TYPE        =   'token';
        var _url        =   OAUTHURL + 'scope=' + SCOPE + '&client_id=' + CLIENTID + '&redirect_uri=' + REDIRECT + '&response_type=' + TYPE;
        var acToken;
        var tokenType;
        var expiresIn;
        var user;
        var loggedIn    =   false;
		
        function login() {
            var win         =   window.open(_url, "windowname1", 'width=800, height=600'); 

            var pollTimer   =   window.setInterval(function() { 
                try {
                    console.log(win.document.URL);
                    if (win.document.URL.indexOf(REDIRECT) != -1) {
                        window.clearInterval(pollTimer);
                        var url =   win.document.URL;
                        acToken =   gup(url, 'access_token');
                        tokenType = gup(url, 'token_type');
                        expiresIn = gup(url, 'expires_in');
                        win.close();

                        validateToken(acToken);
                        console.log("try logging in");
                    }
                } catch(e) {
                }
            }, 500);
        }

        function validateToken(token) {
            $.ajax({
                url: VALIDURL + token,
                data: null,
                success: function(responseText){  
                    addRowSample();
                    loggedIn = true;
                    $('#loginText').hide();
                    $('#logoutText').show();
                },  
                dataType: "jsonp"  
            });
        }

        function getUserInfo() {
            $.ajax({
                url: 'https://www.googleapis.com/oauth2/v1/userinfo?access_token=' + acToken,
                data: null,
                success: function(resp) {
                    user    =   resp;
                    console.log(user);
                    $('#uName').text('Welcome ' + user.name);
                    $('#imgHolder').attr('src', user.picture);
                },
                dataType: "jsonp"
            });
        }
        /*
        function xhrFetch(path, callback) {
      		var xhr = new XMLHttpRequest();
      		xhr.open("GET", this.endpoint + path);
      
      		console.log(path);
      
      		var self = this;
      		xhr.onload = function() {
        		try {
          			var json = JSON.parse(xhr.responseText);
        		} catch (e) {
          			console.error(e);
        		}
        		console.log("onload executed.");
      		};
      		xhr.send();
    	}
        */
        //AJAX XMLhttpRequest shouldn't be made cross site
        //CORS needs to be enabled...here it seems to be enabled anyway...
        function addRowSample()
        {
        	var supportsCORS = false;
	        try 
	        {
    			var testXHR = new XMLHttpRequest();
    			if (typeof testXHR.withCredentials !== 'undefined') 
    			{
      				supportsCORS = true;
    			}
    			else 
    			{
		        	if ("XDomainRequest" in window) 
		        	{
        				supportsCORS = true;
        				inLegacyIE = true;
      				}
    			}
  			}
  			catch (e) 
  			{ }
			console.log(supportsCORS);
        
        	var key = "0AlW1a4Iy0WNvdE1tT1lub09qS3lUT0hjMTEyMi1Vc0E";
        	var listURL = "https://spreadsheets.google.com/feeds/list/" + key + "/HistorySheet/private/full?access_token=" + acToken;
        	console.log(listURL)
        	var XMLData = "<entry xmlns=\"http://www.w3.org/2005/Atom\" \
   		 		xmlns:gsx=\"http://schemas.google.com/spreadsheets/2006/extended\"> \
   		 		<link rel=\"http://schemas.google.com/g/2005#post\" href=\""+ listURL +"\"> \
   		 		<gsx:time>1</gsx:time> \
  				<gsx:receiver>1</gsx:receiver> \
  				<gsx:line>60</gsx:line> \
  				<gsx:sender>Elizabeth Bennet</gsx:sender> \
				</entry>";
				
				/*
			var XMLData = "<entry gd:etag=\'\"S0wCTlpIIip7ImA0X0QI\"\'> \
  <id>https://spreadsheets.google.com/feeds/list/0AlW1a4Iy0WNvdE1tT1lub09qS3lUT0hjMTEyMi1Vc0E/HistorySheet/private/full/1</id> \
  <updated>2006-11-17T18:23:45.173Z</updated> \
  <category scheme=\"http://schemas.google.com/spreadsheets/2006\"\
    term=\"http://schemas.google.com/spreadsheets/2006#list\"/>\
  <title type=\"text\">Bingley</title>\
  <content type=\"text\">Hours: 10, Items: 2, IPM: 0.0033</content>\
  <link rel=\"self\" type=\"application/atom+xml\"\
    href=\"https://spreadsheets.google.com/feeds/list/0AlW1a4Iy0WNvdE1tT1lub09qS3lUT0hjMTEyMi1Vc0E/HistorySheet/private/full/1\"/>\
  <link rel=\"edit\" type=\"application/atom+xml\"\
    href=\"https://spreadsheets.google.com/feeds/list/0AlW1a4Iy0WNvdE1tT1lub09qS3lUT0hjMTEyMi1Vc0E/HistorySheet/private/full/1/version\"/>\
  <gsx:name>Bingley</gsx:name>\
  <gsx:hours>20</gsx:hours>\
  <gsx:items>4</gsx:items>\
  <gsx:ipm>0.0033</gsx:ipm>\
</entry>";
				*/
        	$.ajax({
                url: listURL,
                type: "POST",
                contentType: 'application/atom+xml',
                data: XMLData,
                success: function(resp) {
                    console.log("ajax request sent");
                }
            });
        }

        //credits: http://www.netlobo.com/url_query_string_javascript.html
        function gup(url, name) {
            name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
            var regexS = "[\\#&]"+name+"=([^&#]*)";
            var regex = new RegExp( regexS );
            var results = regex.exec( url );
            if( results == null )
                return "";
            else
                return results[1];
        }

        function startLogoutPolling() {
            $('#loginText').show();
            $('#logoutText').hide();
            loggedIn = false;
            $('#uName').text('Welcome ');
            $('#imgHolder').attr('src', 'none.jpg');
        }

    </script>
    <?php
    // load Zend Gdata libraries
		require_once 'Zend/Loader.php';
		Zend_Loader::loadClass('Zend_Gdata_Spreadsheets');
		Zend_Loader::loadClass('Zend_Gdata_ClientLogin');

// set credentials for ClientLogin authentication
		$user = "wangzhehao410305@gmail.com";
		$pass = "wzh410305";

		try {
  // connect to API
  			$service = Zend_Gdata_Spreadsheets::AUTH_SERVICE_NAME;
  			$client = Zend_Gdata_ClientLogin::getHttpClient($user, $pass, $service);
  			$service = new Zend_Gdata_Spreadsheets($client);

  // set target spreadsheet and worksheet
  			$ssKey = 'ssid';
  			$wsKey = 'wsid';

  // update cell at row 6, column 5
  			$entry = $service->updateCell('6', '5', 'Hello, world', $ssKey, $wsKey);
  			echo 'Updated cell ' . $entry->getTitle()->getText() . '';

  // clear cell at row 1, column 1
  			$entry = $service->updateCell('1', '1', '', $ssKey, $wsKey);
  			echo 'Cleared cell ' . $entry->getTitle()->getText();

		} catch (Exception $e) {
  			die('ERROR: ' . $e->getMessage());
		}
    ?>
</head>

<body>
<!--
	<button id="authButton" onclick="auth()">Auth</button>
-->
<!--
    <a href='#' onClick='login();' id="loginText"'> Click here to login </a>
    <a href="#" style="display:none" id="logoutText" target='myIFrame' onclick="myIFrame.location='https://www.google.com/accounts/Logout'; startLogoutPolling();return false;"> Click here to logout </a>
    <iframe name='myIFrame' id="myIFrame" style='display:none'></iframe>
    <div id='uName'></div>
    <img src='' id='imgHolder'/>
-->
    <script src="https://apis.google.com/js/client.js"></script>
    <script src="https://script.google.com/macros/s/AKfycbyeuu4cRGGxoFjVl3oFuP_eTJvUma_2MrXFdNMCKaMdXKTGpbo3/exec?source=script&type=javascript&module=hacks&library=mcpher"></script>
    <script>
      function auth() {
        var config = {
      'client_id': '324206727795-6k03tjrjecfg2c7l30l9avea2pb011v4.apps.googleusercontent.com',
          'scope': 'https://www.googleapis.com/auth/urlshortener'
        };
        gapi.auth.authorize(config, function() {
          console.log('login complete');
          console.log(gapi.auth.getToken());
        });
        
        function write() {
          appendContent("1","2","3","4");
        }
      }
    </script>
    <button onclick="write();">Write</button>

</body>
</html>